<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="logo.png" type="image/png">

<link rel="apple-touch-icon" href="logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAIM SISTEMA - Oficial</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background-image: url('Inicio.jpg'); background-size: cover; background-attachment: fixed; min-height: 100vh; padding: 20px; }
        
        /* Barra de navegaci√≥n con nombre */
        .navbar { 
            background: #2c3e50; color: white; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 10px; margin-bottom: 20px; 
        }
        .user-tag { background: #1abc9c; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        
        .welcome-banner { background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #1abc9c; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat { background: white; flex: 1; padding: 15px; border-radius: 10px; text-align: center; border-top: 5px solid #1abc9c; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background: #1abc9c; width: 100%; margin-top: 10px; }
        .btn-in { background: #27ae60; }
        .btn-out { background: #e67e22; }
        .status-alert { background: #ffeded; color: #c0392b; font-weight: bold; }
        .log { background: #f9f9f9; padding: 10px; height: 100px; overflow-y: auto; font-size: 0.8rem; border-radius: 5px; }
    </style>
</head>
<body>

<div class="navbar">
    <h2>CRAIM | CDI EMILIO JUAREZ</h2>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span class="user-tag" id="nombreNav">Usuario</span>
        <button onclick="cerrarSesion()" style="background:#e74c3c; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">Cerrar Sesi√≥n</button>
    </div>
</div>

<div class="welcome-banner">
    <h3 id="mensajeBienvenida">Cargando sesi√≥n...</h3>
</div>

<div class="stats">
    <div class="stat"><h3>Total Insumos</h3><p id="tInsumos">0</p></div>
    <div class="stat"><h3>Alertas</h3><p id="tAlertas">0</p></div>
</div>

<div class="card">
    <h3>üì¶ Registro de Nuevo Insumo</h3>
    <div style="display: flex; flex-wrap: wrap;">
        <input type="text" id="nom" placeholder="Nombre">
        <select id="cat">
            <option>Medicamento</option>
            <option>Material M√©dico</option>
            <option>Equipo</option>
        </select>
        <input type="number" id="can" placeholder="Cantidad">
        <input type="date" id="fec">
    </div>
    <button class="btn btn-add" onclick="crearRegistro()">Crear Registro</button>
</div>

<div class="card">
    <table id="miTabla">
        <thead>
            <tr>
                <th>Insumo</th>
                <th>Stock</th>
                <th>Vencimiento</th>
                <th>Gesti√≥n (Kardex)</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody id="lista"></tbody>
    </table>
</div>

<div class="card">
    <h4>üßæ BIT√ÅCORA</h4>
    <div id="bitacora" class="log"></div>
</div>

<script>
    // L√ìGICA DE USUARIO
    const usuarioActual = localStorage.getItem('usuarioActual') || 'Invitado';
    
    // Mostramos el nombre en la interfaz
    document.getElementById('nombreNav').innerText = "üë§ " + usuarioActual.toUpperCase();
    document.getElementById('mensajeBienvenida').innerText = "¬°Bienvenido(a), " + usuarioActual + "! Usted est√° gestionando el inventario.";

    const KEY = 'inventario_final_' + usuarioActual;
    const LOG_KEY = 'log_final_' + usuarioActual;

    let inventario = JSON.parse(localStorage.getItem(KEY)) || [];
    let logs = JSON.parse(localStorage.getItem(LOG_KEY)) || [];

    function crearRegistro() {
        const n = document.getElementById('nom').value;
        const c = document.getElementById('cat').value;
        const q = parseInt(document.getElementById('can').value);
        const f = document.getElementById('fec').value;

        if(!n || !q || !f) return alert("Faltan datos");

        inventario.push({id: Date.now(), n, c, q, f});
        addLog("REGISTRO: " + n + " (" + q + " und)");
        actualizar();
        
        document.getElementById('nom').value = "";
        document.getElementById('can').value = "";
    }

    function kardex(id, tipo) {
        const cant = prompt("¬øQu√© cantidad desea " + (tipo === 'in' ? 'ingresar?' : 'retirar?'));
        const valor = parseInt(cant);
        if(!valor || valor <= 0) return;

        let item = inventario.find(i => i.id === id);
        if(tipo === 'out' && item.q < valor) return alert("Stock insuficiente");

        if(tipo === 'in') {
            item.q += valor;
            addLog("ENTRADA: " + valor + " de " + item.n);
        } else {
            item.q -= valor;
            addLog("SALIDA: " + valor + " de " + item.n);
        }
        actualizar();
    }

    function borrar(id) {
        if(confirm("¬øEliminar este registro permanentemente?")) {
            inventario = inventario.filter(i => i.id !== id);
            actualizar();
        }
    }

    function addLog(msg) {
        logs.unshift(new Date().toLocaleTimeString() + " - " + msg);
        if(logs.length > 10) logs.pop();
        localStorage.setItem(LOG_KEY, JSON.stringify(logs));
    }

    function actualizar() {
        localStorage.setItem(KEY, JSON.stringify(inventario));
        const lista = document.getElementById('lista');
        lista.innerHTML = "";
        let alertas = 0;
        const hoy = new Date();

        inventario.forEach(i => {
            const fechaV = new Date(i.f);
            let css = (fechaV <= hoy || i.q <= 5) ? "status-alert" : "";
            if(css !== "") alertas++;

            lista.innerHTML += `
                <tr class="${css}">
                    <td>${i.n}<br><small>${i.c}</small></td>
                    <td><strong>${i.q}</strong></td>
                    <td>${i.f}</td>
                    <td>
                        <button class="btn btn-in" onclick="kardex(${i.id}, 'in')">‚¨Ü Entrar</button>
                        <button class="btn btn-out" onclick="kardex(${i.id}, 'out')">‚¨á Salir</button>
                    </td>
                    <td><button onclick="borrar(${i.id})" style="background:none; border:none; color:red; cursor:pointer;">‚úñ</button></td>
                </tr>
            `;
        });
        document.getElementById('tInsumos').innerText = inventario.length;
        document.getElementById('tAlertas').innerText = alertas;
        document.getElementById('bitacora').innerHTML = logs.join("<br>");
    }

    function cerrarSesion() {
        localStorage.removeItem('sesionIniciada');
        // No borramos 'usuarioActual' para que no de error al volver, 
        // pero la sesi√≥n quedar√° cerrada.
        window.location.href = 'index.html';
    }

    actualizar();
</script>
</body>
</html>